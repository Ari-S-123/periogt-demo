Bootstrap: docker
From: nvidia/cuda:12.6.0-runtime-ubuntu22.04

%files
./ /opt/periogt

%environment
    export DGLBACKEND=pytorch
    export PYTHONPATH=/opt/periogt/services/modal-api:/opt/periogt/services/hpc:${PYTHONPATH}
    export PERIOGT_RUNTIME_PACKAGE_DIR=/opt/periogt/services/modal-api
    export PERIOGT_SRC_DIR=/opt/periogt/services/modal-api/periogt_src/source_code/PerioGT_common

%post
    apt-get update && apt-get install -y --no-install-recommends \
      ca-certificates \
      curl \
      git \
      libgl1-mesa-glx \
      libglib2.0-0 \
      python3.11 \
      python3.11-venv \
      python3-pip \
      && rm -rf /var/lib/apt/lists/*

    if [ ! -x /usr/bin/python3.11 ]; then
      apt-get update && apt-get install -y --no-install-recommends python3 python3-pip && rm -rf /var/lib/apt/lists/*
      ln -sf /usr/bin/python3 /usr/bin/python
    else
      ln -sf /usr/bin/python3.11 /usr/bin/python
    fi

    python -m pip install --upgrade pip
    python -m pip install --index-url https://download.pytorch.org/whl/cu126 torch==2.6.0
    python -m pip install --find-links https://data.dgl.ai/wheels/torch-2.6/cu126/repo.html dgl
    python -m pip install \
      "numpy<2" \
      scipy \
      scikit-learn \
      pandas \
      networkx \
      pyyaml \
      rdkit \
      dgllife \
      mordred \
      fastapi \
      "uvicorn[standard]" \
      "pydantic>=2.8,<3" \
      click \
      pytest

    python -m pip install /opt/periogt/services/hpc

%runscript
    exec python -m periogt_hpc "$@"

